---
import Layout from "@layouts/Layout.astro";
import List from "@components/List.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";

import fetchApi from "@lib/strapi";
import type Service from "@interfaces/service";

import getServises from "@data/getServices";

import { marked } from 'marked';

const pages = await getServises();

export async function getStaticPaths() {
  const services = await fetchApi<Service[]>({
    endpoint: "services",
    wrappedByKey: "data",
  });

  return services.map((service) => ({
    params: { slug: service.attributes.slug },
    props: service,
  }));
}

type Props = Service;

const service = Astro.props;
const { title, slug, textTitle } = service.attributes;

const description = marked.parse(service.attributes.description);
const text = marked.parse(service.attributes.text);
const result = marked.parse(service.attributes.result);

const otherServices = pages.filter((page) => page.slug !== slug);

type Crumb = {
  title: string;
  href?: string;
};

const breadcrumbs: Crumb[] = [
  {
    title: "Главная",
    href: "/",
  },
  {
    title: "Услуги",
    href: "/services/",
  },
  {
    title: title,
  },
];
---

<Layout title={title}>
  <section class="section">
    <h2 class="title">{title}</h2>
    <div class="page">
      <Breadcrumbs breadcrumbs={breadcrumbs} />
      <div class="page-content">
        <div class="page-blocks">
          {
            description && (
              <div class="page-block">
                <div class="page-block-title">Описание услуги</div>
                <div class="page-block-text" set:html={description}></div>
              </div>
            )
          }

          {
            text && (
              <div class="page-block">
                <div class="page-block-title">{textTitle}</div>
                <div class="page-block-text" set:html={text}></div>
              </div>
            )
          }

          {
            result && (
              <div class="page-block">
                <div class="page-block-title">результат</div>
                <div class="page-block-text" set:html={result}></div>
              </div>
            )
          }

          <button class="btn show-modal">Оставить заявку на услугу</button>
        </div>
      </div>
    </div>
  </section>

  <section class="section">
    <h2 class="title">Другие услуги</h2>
    <List list={otherServices} />
  </section>
</Layout>
